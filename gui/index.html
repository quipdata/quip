<html>
<head>
	<!--Foreign Libraries-->
	<script src='https://cdn.firebase.com/js/client/1.0.11/firebase.js'></script>
	<script src='lib/jquery-2.1.0.min.js'></script>
	<script src="lib/kinetic-v5.1.0.min.js"></script>
	<script src='lib/uuid.js'></script>
	
	<!--Dev Created Libraries-->
	<script src='lib/functions.js'></script>
	<script src="lib/kinetic.prototype.js"></script>
	<script src="lib/kinetic+.js"></script>
	<script src="lib/cloud_handler.js"></script>
	<script src="lib/transaction.js"></script>
	<script src="lib/transaction.cloud.js"></script>
	<script src="lib/error_handler.js"></script>
</head>
<body>
	<button onclick="refresh()">Refresh</button>
	<div name="errors" id="errors" style="min-width: 800px;display: none;"></div>
	<div name="console" id="console" style="border-style: solid;min-width: 800px;min-height: 500px;">Loading...</div>
	<button onclick="refresh()">Refresh</button>
    <script>
    	var fbModel = new Firebase('{{FirebaseRef}}');
    	
    	var userID = '{{UserUUID}}';
    	var model = {};
    	var errors = [];

		function test(){ 	
			var newModelID = uuid.v4();
	
			var actions = [
				{	"objectID" : "#/Model/Model/ModelObjects/" + newModelID,
					"commandType" : "insert",
					"value" : {
					    "id": "#/Model/Model/ModelObjects/" + newModelID,
					    "name": "",
					    "type": "Object",
					    "notes": "",
					    "ModelRelationshipConnectors": { "empty":"" }
					}
				}
			]
			
			var trans = createTransaction( "Model", actions );
			
			var newID = uuid.v4();
			var objID = uuid.v4();
			
			var visualActions = [
				{	"objectID" : "#/VisualModel/groups/" + newID,
					"commandType" : "insert",
					"value" : {
					    "type": "Object",
					    "id": "#/VisualModel/groups/"  + newID,
					    "modelID": "#/Model/Model/ModelObjects/" + newModelID,
					    "selectedBy": "default",
					    "attr": {
							x: 100,
							y: 100,
							draggable: true
						},
					    "function": {},
					    "objects": {}
					}
				}
			]
			
			visualActions[0]['value']['objects'][objID] = {
			    "id": "#/VisualModel/groups/" + newID + "/objects/" + objID,
			    "modelID": "#/Model/Model/ModelObjects/" + newModelID,
			    "class": "Rect",
			    "attr": {
					width: 40,
					height: 40,
					stroke: 'black',
					strokeWidth: 1,
					cornerRadius: 8,
					fill: 'white',
					name: 'content'
				},
			    "function": {},
			    "links": {"empty":""}
			}
			
			var vaString = JSON.stringify( visualActions );
			var va2 = $.parseJSON( vaString );
			va2[0].commandType = 'update';
			
			objID = uuid.v4();
			
			va2[0]['value']['objects'][objID] = {
			    "id": "#/VisualModel/groups/" + newID + "/objects/" + objID,
			    "modelID": "#/Model/Model/ModelObjects/" + newModelID,
			    "class": "Text",
			    "attr": {
					x: 5,
					y: 10,
					fontSize: 10,
					fontFamily: 'Calibri',
					fill: 'black',
					text: 'Person'
			  	},
			    "function": {},
			    "links": {"empty":""}
			}
			
			var trans = createTransaction( "VisualModel", visualActions, trans );
			
			processTransactions( trans );
			
			var actions = [
				{	"objectID" : "#/Model/Model/ModelObjects/" + newModelID,
					"commandType" : "update",
					"value" : {
					    "id": "#/Model/Model/ModelObjects/" + newModelID,
					    "name": "Person",
					    "type": "Object",
					    "notes": "",
					    "ModelRelationshipConnectors": { "empty":"" }
					}
				}
			]
			
			var trans2 = createTransaction( "Model", actions ); 
	
			var trans2 = createTransaction( "VisualModel", va2, trans2 );
			
			processTransactions( trans2 );
			
			var comment = [
				{	"objectID" : "#/VisualModel/comments/bc22185f-0d6c-468a-9267-54466f666821",
					"commandType" : "insert",
					"value" : {
					    "id": "#/VisualModel/comments/bc22185f-0d6c-468a-9267-54466f666821",
					    "selectedBy": "default",
					    "attr": {
							x: 100,
							y: 100,
							draggable: true
						},
					    "function": {},
					    "objects": {}
					}
				}
			]
			
			objID = uuid.v4();
			
			comment[0]['value']['objects'][objID] = {
			    "id": "#/VisualModel/comments/bc22185f-0d6c-468a-9267-54466f666821/objects/" + objID,
			    "class": "Rect",
			    "attr": {
					width: 40,
					height: 40,
					stroke: 'black',
					strokeWidth: 1,
					cornerRadius: 8,
					fill: 'yellow',
					name: 'content'
				},
			    "function": {},
			    "links": {"empty":""}
			}
			
			var trans3 = createTransaction( "VisualModel", comment );
			
			processTransactions( trans3 );
		}
    	
		fbModel.once('value', function(data) {
			model = data.val();
			setListeners();
			refresh();
			test();
			
			var modelObjects = fbModel.child( 'loaded' );
			modelObjects.set(true);
		});
		
		function refresh(){			
			var sModel = JSON.stringify(model);
			
			var output = JSONStringToHTML( sModel );
			
			$('#console').html(output);
			
			if( errors.length > 0 ){
				var sErrors = JSON.stringify( errors );
				var eOutput = JSONStringToHTML( sErrors );
				$('#errors').html(eOutput)
					.show();				
			}
		}
    </script>
  </body>
</html>